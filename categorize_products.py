"""
categorize_products.py  — v2 (comprehensive)
=============================================
Classifies the 2,199 products in "פריטים ללא קבוצת משנה.xlsx" by matching
them to the category taxonomy in "קבוצות קומקס.xlsx".

New in v2:
  - Dept 35 "פיצוחים עם מע"מ" (roasted nuts, dried fruits, nut snacks)
  - New subgroups under dept 34 (natural VAT-exempt nuts)
  - New subgroup 8416 (מכשירי מדידה) under NF > מוצרי חשמל
  - VAT-aware nut classification (natural=ללא מע"מ, processed=עם מע"מ)
  - Subgroup ID column in output (מספר ק.משנה)
  - Comprehensive rules: candles, Purim, pharmacy, laundry, sweets, etc.

Output:
  - פריטים_מעודכנים.xlsx  — full updated product list with sub_id column

Usage:
  python3 categorize_products.py
"""

import openpyxl
from openpyxl.styles import PatternFill, Font
from collections import defaultdict

TAXONOMY_FILE = "קבוצות קומקס.xlsx"
PRODUCTS_FILE = "פריטים ללא קבוצת משנה.xlsx"
OUTPUT_FILE   = "פריטים_מעודכנים.xlsx"

# ---------------------------------------------------------------------------
# New taxonomy entries (new departments / groups / subgroups to be created)
# These extend the loaded taxonomy in-memory so the ID lookup works.
# ---------------------------------------------------------------------------

NEW_TAXONOMY_ENTRIES = [
    # ── Dept 35: פיצוחים עם מע"מ  (new department) ──────────────────────────
    # Group 351: פיצוחים קלויים
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=351,  grp_name="פיצוחים קלויים",
         sub_id=3511, sub_name="שקדים קלויים"),
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=351,  grp_name="פיצוחים קלויים",
         sub_id=3512, sub_name="בוטנים קלויים"),
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=351,  grp_name="פיצוחים קלויים",
         sub_id=3513, sub_name="אגוזים קלויים"),
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=351,  grp_name="פיצוחים קלויים",
         sub_id=3514, sub_name="גרעינים קלויים"),
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=351,  grp_name="פיצוחים קלויים",
         sub_id=3515, sub_name="קשיו ופיסטוק קלויים"),
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=351,  grp_name="פיצוחים קלויים",
         sub_id=3516, sub_name="חומוס ודגנים קלויים"),
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=351,  grp_name="פיצוחים קלויים",
         sub_id=3517, sub_name="תערובות פיצוחים"),
    # Group 352: פירות יבשים
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=352,  grp_name="פירות יבשים",
         sub_id=3521, sub_name="פירות יבשים"),
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=352,  grp_name="פירות יבשים",
         sub_id=3522, sub_name="חטיפי פירות"),
    # Group 353: חטיפי פיצוחים
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=353,  grp_name="חטיפי פיצוחים",
         sub_id=3531, sub_name="קבוקים וקרנצוס"),
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=353,  grp_name="חטיפי פיצוחים",
         sub_id=3532, sub_name="פופקורן"),
    # Group 354: ממתקי פיצוחים
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=35,  dept_name='פיצוחים עם מע"מ',
         grp_id=354,  grp_name="ממתקי פיצוחים",
         sub_id=3541, sub_name="ממתקי פיצוחים"),

    # ── Dept 34: new subgroups (פיצוחים ללא מע"מ) ───────────────────────────
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=34,  dept_name='פיצוחים ללא מע"מ',
         grp_id=341,  grp_name='פיצוחים ללא מע"מ',
         sub_id=3412, sub_name='בוטנים ללא מע"מ'),
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=34,  dept_name='פיצוחים ללא מע"מ',
         grp_id=341,  grp_name='פיצוחים ללא מע"מ',
         sub_id=3413, sub_name='אגוזי מלך ללא מע"מ'),
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=34,  dept_name='פיצוחים ללא מע"מ',
         grp_id=341,  grp_name='פיצוחים ללא מע"מ',
         sub_id=3414, sub_name='גרעינים ללא מע"מ'),
    dict(domain_id=3, domain_name="פירות וירקות",
         dept_id=34,  dept_name='פיצוחים ללא מע"מ',
         grp_id=341,  grp_name='פיצוחים ללא מע"מ',
         sub_id=3415, sub_name='פיצוחים טבעיים שונים'),

    # ── Dept 84 / Group 841: new subgroup 8416 (משקל אדם) ───────────────────
    dict(domain_id=8, domain_name="NF",
         dept_id=84,  dept_name="מוצרי חשמל",
         grp_id=841,  grp_name="מכשירי חשמל לבית",
         sub_id=8416, sub_name="מכשירי מדידה"),

    # ── Dept 53: דגים טריים (not in taxonomy — new dept) ────────────────────
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=53,  dept_name="דגים טריים",
         grp_id=530,  grp_name="דגים טריים",
         sub_id=5301, sub_name="דג שלם טרי"),
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=53,  dept_name="דגים טריים",
         grp_id=530,  grp_name="דגים טריים",
         sub_id=5302, sub_name="פילה דג טרי"),

    # ── Dept 54: קצביה בקר טרי (not in taxonomy — new dept) ─────────────────
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=54,  dept_name="קצביה בקר טרי",
         grp_id=540,  grp_name="חלקי בשר טרי",
         sub_id=5401, sub_name="נתחי בקר"),
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=54,  dept_name="קצביה בקר טרי",
         grp_id=540,  grp_name="חלקי בשר טרי",
         sub_id=5402, sub_name="בשר טחון"),

    # ── Dept 55: קצביה עופות טריים (not in taxonomy — new dept) ─────────────
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=55,  dept_name="קצביה עופות טריים",
         grp_id=551,  grp_name="חלקי עוף טרי",
         sub_id=5511, sub_name="חלקי עוף"),
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=55,  dept_name="קצביה עופות טריים",
         grp_id=551,  grp_name="חלקי עוף טרי",
         sub_id=5512, sub_name="עוף שלם"),
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=55,  dept_name="קצביה עופות טריים",
         grp_id=552,  grp_name="עוף והודו טחון",
         sub_id=5521, sub_name="עוף טחון"),
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=55,  dept_name="קצביה עופות טריים",
         grp_id=553,  grp_name="הודו טרי",
         sub_id=5531, sub_name="חלקי הודו"),

    # ── NF — יודאיקה (new dept) ───────────────────────────────────────────────
    dict(domain_id=8, domain_name="NF",
         dept_id=89,  dept_name="יודאיקה",
         grp_id=891,  grp_name="ציצית וטלית",
         sub_id=8911, sub_name="ציצית וטלית"),

    # ── Actual group names used in products file (Case-1 matching) ────────────
    # Products have grp="עוף טרי שלם" (not "חלקי עוף טרי")
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=55,  dept_name="קצביה עופות טריים",
         grp_id=554,  grp_name="עוף טרי שלם",
         sub_id=5513, sub_name="עוף שלם"),
    # Products have grp="בשר טרי טחון" (not "חלקי בשר טרי")
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=54,  dept_name="קצביה בקר טרי",
         grp_id=541,  grp_name="בשר טרי טחון",
         sub_id=5403, sub_name="בשר טחון"),
    # Products have grp="בשר טרי ארוז"
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=54,  dept_name="קצביה בקר טרי",
         grp_id=542,  grp_name="בשר טרי ארוז",
         sub_id=5404, sub_name="נתחי בקר"),
    # Products have grp="דגים טריים ארוזים"
    dict(domain_id=5, domain_name="מצוננים",
         dept_id=53,  dept_name="דגים טריים",
         grp_id=531,  grp_name="דגים טריים ארוזים",
         sub_id=5303, sub_name="פילה דג טרי"),
]


# ---------------------------------------------------------------------------
# 1. Load taxonomy + extend with new entries
# ---------------------------------------------------------------------------

def load_taxonomy(path):
    """Returns list of dicts (domain→dept→group→subgroup)."""
    wb = openpyxl.load_workbook(path)
    ws = wb.active
    rows = []
    for row in ws.iter_rows(min_row=2, values_only=True):
        domain_id, domain_name, dept_id, dept_name, grp_id, grp_name, sub_id, sub_name, count = row
        if domain_name is None:
            continue
        rows.append({
            "domain_id":   domain_id,
            "domain_name": domain_name,
            "dept_id":     dept_id,
            "dept_name":   dept_name,
            "grp_id":      grp_id,
            "grp_name":    grp_name,
            "sub_id":      sub_id,
            "sub_name":    sub_name,
        })
    rows.extend(NEW_TAXONOMY_ENTRIES)
    return rows


def build_lookup(taxonomy):
    by_dept_group = defaultdict(list)
    by_dept       = defaultdict(list)
    for t in taxonomy:
        dept = (t["dept_name"] or "").strip()
        grp  = (t["grp_name"]  or "").strip()
        sub  = (t["sub_name"]  or "").strip()
        if dept and grp and sub:
            by_dept_group[(dept.lower(), grp.lower())].append(t)
        if dept:
            by_dept[dept.lower()].append(t)
    return by_dept_group, by_dept


# ---------------------------------------------------------------------------
# 2. Subgroup ID lookup
# ---------------------------------------------------------------------------

def find_sub_id(domain, dept, group, sub, taxonomy):
    """Return sub_id for an exact path, or None if not found."""
    for t in taxonomy:
        if (t["domain_name"] == domain and
                t["dept_name"] == dept and
                t["grp_name"]  == group and
                t["sub_name"]  == sub):
            return t["sub_id"]
    return None


def find_subgroup_full(dept_name, group_name, product_name, taxonomy):
    """
    Given existing dept + group, find best subgroup.
    Returns (sub_name, sub_id) or (None, None).
    """
    matches = [t for t in taxonomy
               if (t["dept_name"] or "").strip() == dept_name
               and (t["grp_name"]  or "").strip() == group_name
               and t["sub_name"]]
    if not matches:
        return None, None
    if len(matches) == 1:
        return matches[0]["sub_name"], matches[0]["sub_id"]
    name_lower = (product_name or "").lower()
    for m in matches:
        words = (m["sub_name"] or "").lower().split()
        if any(w in name_lower for w in words if len(w) > 2):
            return m["sub_name"], m["sub_id"]
    return matches[0]["sub_name"], matches[0]["sub_id"]


# ---------------------------------------------------------------------------
# 3. Classification rules
# ---------------------------------------------------------------------------
#
# Format: (list_of_keywords,  (domain, dept, group, subgroup))
# Matching is case-insensitive substring search on the product name.
# MORE SPECIFIC RULES MUST COME FIRST.
#
# VAT rule for nuts:
#   "טבעי" or "עם קליפה" (without "קלוף") → ללא מע"מ  (dept 34)
#   Everything else (קלוי, קלוף, מולבן, טחון, פרוס)  → עם מע"מ  (dept 35)
#   Blanched/ground nuts used in baking                → מזון יבש (1865)
# ---------------------------------------------------------------------------

RULES = [

    # ══ CANDLES & JUDAICA ══════════════════════════════════════════════════
    (["נרות הבדלה", "נר הבדלה"],
     ("ניקיון", "טיפוח הבית", "נרות", "נרות הבדלה")),
    (["נרות נשמה", "נר נשמה"],
     ("ניקיון", "טיפוח הבית", "נרות", "נרות נשמה")),
    (["נרות שבת", "נר שבת"],
     ("ניקיון", "טיפוח הבית", "נרות", "נרות שבת")),
    (["נרונים", "נרות חימום", "כוסיות לנרונים"],
     ("ניקיון", "טיפוח הבית", "נרות", "נרות חימום")),
    (["שמן פרפין", "שמן למאור", "פרפין"],
     ("ניקיון", "טיפוח הבית", "נרות", "שמן למאור")),
    (["פתילות", "פתיל"],
     ("ניקיון", "טיפוח הבית", "נרות", "פתילות")),
    (["גפרורים", "גפרור"],
     ("ניקיון", "טיפוח הבית", "נרות", "גפרורים")),
    (["כוסיות קריסטל", "כוסית קריסטל", "פמוטות",
      "כוסיות זכוכית", "כוסית זכוכית"],
     ("ניקיון", "טיפוח הבית", "נרות", "אביזרים לנרות")),

    # ══ PURIM ══════════════════════════════════════════════════════════════
    (["מגילת אסתר", "מגילה מרובעת", "מגילה לצביעה"],
     ("NF", "חגים", "פורים", "מגילות אסתר")),
    (["תחפושת", "תחפושות"],
     ("NF", "חגים", "פורים", "תחפושות ואביזרים")),
    (["רעשן"],
     ("NF", "חגים", "פורים", "תחפושות ואביזרים")),
    (["בובות סול", "דמויות המגילה"],
     ("NF", "חגים", "פורים", "תחפושות ואביזרים")),
    # Mishloach manot accessories (containers, bags, trays, ribbons)
    (["מגש מאורך", "מגש נייר", "מגש קרטון", "קערת קרטון",
      "תבנית מתכת עם מדבקת פורים", "דלי משלוח מנות",
      "מזוודת משלוח מנות", "מארז לוונדר"],
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),
    (["מגש דג", "מגש אובלי", "מגש זהב", "מגש שחור",
      "מגש בורדו", "מגש כחול", "מגש צבעוני", "מגש מסכה"],
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),
    (["שקית צלופן", "שקיות צלופן", "שקית פורים שמח",
      "שקית מעטפה פורים", "שקית תלת מימד פורים",
      "שקית ליין", "שקית גלידה ב",
      "גליל נילון", "גליל צלופן", "צלופן מארז"],
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),
    (["שקית בוטיק", "שקית אורגנזה", "שקית נייר"],
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),
    (["סרט מתנה", "סרט סאטן", "סרט פס", "גלילי סרט"],
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),
    (["פנקס דפי פורים", "פנקס A6 פורים", "פנקס A5 פורים",
      "פנקס A7 פורים", "פנקס בקבוק", "פנקס A6", "פנקס A5"],
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),
    (["מדבקות פורים", "מדבקות בקבוק", "מדבקות שמחת פורים"],
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),
    (["כרטיסים ומעטפות", "מעטפות וכרטיסים", "מעטפות וגלויות"],
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),
    (["קופסא מנשא לבקבוק", "קופסא מתקפלת פרצוף",
      "סל רטרו", "סלסלה צבעונית", "דלי צבעוני", "דלי במבוק",
      "סלסלה מלבנית", "סלסלה איכותית"],
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),
    (["פרחי קישוט", "פרחים וביצה", "פרחים וסרט"],
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),
    (["סט שולחן לפורים", "שרשרת קישוט פורים",
      "בלון ניפוח פורים", "קונפטי", "מגנט דביק",
      "פאזל פורים", "פאזל מדבקות פורים", "פאזל פלסטיק פורים"],
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),
    (["תוף שר מצוה", "אורגן שר מצוה"],
     ("NF", "חגים", "פורים", "תחפושות ואביזרים")),
    (["פורים"],          # catch-all for Purim keywords
     ("NF", "חגים", "פורים", "אביזרים למשלוחי מנות")),

    # ══ CHANUKAH ════════════════════════════════════════════════════════════
    (["סביבון", "חנוכיה"],
     ("NF", "חגים", "חנוכה", "סביבונים")),
    (["חנוכה"],
     ("NF", "חגים", "חנוכה", "משחקי חנוכה")),

    # ══ GENERAL HOLIDAY ════════════════════════════════════════════════════
    (["שקית חג", "שקיות חג"],
     ("NF", "חגים", "חגים כללי", "שקיות חג")),

    # ══ NUTS — VAT-EXEMPT (natural / unprocessed) ══════════════════════════
    # Must come BEFORE roasted/processed nut rules
    (["שקד טבעי", "שקדים טבעי", "שקד עם קליפה", "שקדים עם קליפה"],
     ("פירות וירקות", 'פיצוחים ללא מע"מ',
      'פיצוחים ללא מע"מ', 'שקדים ללא מע"מ')),
    (["בוטן טבעי", "בוטנים טבעי"],
     ("פירות וירקות", 'פיצוחים ללא מע"מ',
      'פיצוחים ללא מע"מ', 'בוטנים ללא מע"מ')),
    (["אגוזי מלך עם קליפה", "אגוזי פקאן עם קליפה",
      "אגוזי לוז עם קליפה", "שקדים עם קליפה מיה",
      "אגוז ברזיל", "בונדוק טבעי"],
     ("פירות וירקות", 'פיצוחים ללא מע"מ',
      'פיצוחים ללא מע"מ', 'אגוזי מלך ללא מע"מ')),
    (["גרעיני חמניה טבעי", "גרעיני דלעת טבעי"],
     ("פירות וירקות", 'פיצוחים ללא מע"מ',
      'פיצוחים ללא מע"מ', 'גרעינים ללא מע"מ')),

    # ══ NUTS — BAKING INGREDIENTS (ground/sliced → dry food) ═══════════════
    (["שקדים טחונים", "שקד טחון", "שקדים מולבנים",
      "שקדים פרוסים", "שקד מולבן",
      "אגוזים טחונים", "אגוז טחון", "קוקוס טחון"],
     ("מזון יבש", "מוצרים לבישול ואפיה",
      "מוצרי עזר לאפיה", "פרג שומשום וקוקוס")),

    # ══ NUTS — WITH VAT (roasted / processed) ══════════════════════════════
    (["שקד קלוי", "שקדים קלויים", "שקד קלויה"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "שקדים קלויים")),
    (["בוטנים קלויים", "בוטן קלוי",
      "בוטנים עם קליפה קלוי", "בוטנים אמריקאים", "בוטן אמריקאי"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "בוטנים קלויים")),
    (["אגוזי מלך קלופים", "אגוז בונדוק קלוי",
      "מקדמיה קלוי", "פקאן מקולף קלוי", "פקאן קלוי",
      "אגוזי לוז קלויים"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "אגוזים קלויים")),
    (["גרעיני חמניה", "גרעיני אבטיח", "גרעיני דלעת",
      "גרעינים קלויים"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "גרעינים קלויים")),
    (["קשיו קלוי", "קשיו מטוגן"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "קשיו ופיסטוק קלויים")),
    (["פיסטוק קלוי"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "קשיו ופיסטוק קלויים")),
    (["חומוס קלוי", "תירס מטוגן", "תירס קלוי"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "חומוס ודגנים קלויים")),
    (["מעורב ירושלמי", "מעורב פיצוחים", "תערובת פיצוחים"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "תערובות פיצוחים")),
    # Nut snacks
    (["קבוקים", "קרנצוס", "רביולי גריל"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "חטיפי פיצוחים", "קבוקים וקרנצוס")),
    (["פופקורן"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "חטיפי פיצוחים", "פופקורן")),
    # Nut-based candies
    (["ממתק פרי בטעמים", "ממתק פרי"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "ממתקי פיצוחים", "ממתקי פיצוחים")),

    # ══ DRIED FRUITS ═══════════════════════════════════════════════════════
    (["לדר", "לדרים"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פירות יבשים", "חטיפי פירות")),
    (["צימוק", "שזיף מיובש", "שזיפים מיובשים",
      "משמש מיובש", "אננס מיובש", "מנגו מיובש",
      "פפאיה", "זנגוויל", "קוקוס רצועות",
      "מנגו טבעי 100%", "אננס מיובש טבעי",
      "פירות יבשים"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פירות יבשים", "פירות יבשים")),

    # ══ SPICES & LEGUMES (dry shelf, not nuts) ══════════════════════════════
    # Spice blends / seasoning mixes
    (["תערובת גריל", "תערובת לדגים", "תערובת לעמבה",
      "תערובת לפרגיות", "תיבול אורז", "ראס אל חנות",
      "חוויג'", "חוויג' למרק", "זעתר ביתי",
      "תבלין גריל", "תבלין לדגים", "תבלין לסטייק",
      "תבלין לפיצה", "תבלין שווארמה",
      "אבקות בישול ותיבול"],
     ("מזון יבש", "מוצרים לבישול ואפיה",
      "תבלינים", "תיבולים ותערובות שונות")),
    # Whole / ground spices
    (["פלפל שחור", "פלפל לבן", "פלפל שאטה",
      "פלפל אנגלי", "פלפל צ'ילי", "פפריקה",
      "כורכום", "כמון", "סומאק", "חילבה",
      "כוסברה ירוקה יבשה", "פטרוזיליה יבשה", "פטרוזליה",
      "טימין", "אורגנו", "מקלות קינמון",
      "קינמון", "מלח לימון", "שום גבישי",
      "אבקת שום", "טוסקנה"],
     ("מזון יבש", "מוצרים לבישול ואפיה",
      "תבלינים", "תיבולים ותערובות שונות")),
    (["בצל מטוגן", "בצל פריך"],
     ("מזון יבש", "מוצרים לבישול ואפיה",
      "תבלינים", "תבלינים בשקית")),
    (["סודה לשתיה"],
     ("מזון יבש", "מוצרים לבישול ואפיה",
      "מוצרים לאפיה", "אבקת אפיה")),
    # Legumes
    (["עדשים אדומות", "עדשים חצאים"],
     ("מזון יבש", "קולינרי", "קטניות", "עדשים")),
    (["לוביה"],
     ("מזון יבש", "קולינרי", "קטניות", "קיטניות שונות")),
    (["צ'יה"],
     ("מזון יבש", "קולינרי", "קטניות", "קיטניות שונות")),
    # Baking extras
    (["פרג", "שומשום"],
     ("מזון יבש", "מוצרים לבישול ואפיה",
      "מוצרי עזר לאפיה", "פרג שומשום וקוקוס")),

    # ══ FRESH VEGETABLES (physically near nuts section) ════════════════════
    (["חזרת"],
     ("פירות וירקות", "ירקות", "שורשיים", "שורש")),
    (["נענע", "עשבי תיבול", "כוסברה טרי", "שמיר טרי"],
     ("פירות וירקות", "ירקות", "ירקות עלים",
      "פטרוזיליה כוסברה נענע שמיר")),

    # ══ FRESH FISH ══════════════════════════════════════════════════════════
    (["פילה דג", "פילה סלמון", "פילה אמנון", "דג מנוקה", "פילה"],
     ("מצוננים", "דגים טריים", "דגים טריים", "פילה דג טרי")),
    (["דניס", "לברק", "אמנון", "קרפיון", "מוסר",
      "בקלה", "פגריה", "כוקיה", "פרידה", "אינטיאס", "דג שלם", "דג טרי"],
     ("מצוננים", "דגים טריים", "דגים טריים", "דג שלם טרי")),

    # ══ MEAT ════════════════════════════════════════════════════════════════
    (["אנטריקוט", "סינטה", "פילה בקר", "אסאדו",
      "שפונדרה", "צלעות", "כתף בקר", "שייטל", "לשון"],
     ("מצוננים", "קצביה בקר טרי", "חלקי בשר טרי", "נתחי בקר")),
    (["בשר טחון", "קציצות"],
     ("מצוננים", "קצביה בקר טרי", "חלקי בשר טרי", "בשר טחון")),
    (["הודו", "חזה הודו", "שוק הודו"],
     ("מצוננים", "קצביה עופות טריים", "הודו טרי", "חלקי הודו")),
    (["חזה עוף", "שוק עוף", "כנף עוף", "ירך עוף",
      "פרגית", "חלקי עוף"],
     ("מצוננים", "קצביה עופות טריים", "חלקי עוף טרי", "חלקי עוף")),
    (["עוף שלם", "עוף ברביקיו", "עוף מלא"],
     ("מצוננים", "קצביה עופות טריים", "חלקי עוף טרי", "עוף שלם")),
    (["עוף טחון", "הודו טחון"],
     ("מצוננים", "קצביה עופות טריים", "עוף והודו טחון", "עוף טחון")),

    # ══ ICE CREAM & FROZEN ══════════════════════════════════════════════════
    (["גודיס", "מארז גלידה", "מארז טילונים", "מאגדת טילונים"],
     ("קפואים", "גלידות", "מאגדות גלידה", "מאגדת טילונים")),
    (["טילון בודד", "שלגון", "קרחון"],
     ("קפואים", "גלידות", "גלידה בודדים", "טילונים בודדים")),
    (["גלידה משפחתית"],
     ("קפואים", "גלידות", "גלידה משפחתית", "גלידה משפחתית חלבית")),

    # ══ BEVERAGES ═══════════════════════════════════════════════════════════
    (["פריניב", "מיץ טבעי"],
     ("משקאות", "משקאות קלים", "נקטרים ומיצים", "מיץ טבעי")),
    (["מיץ", "נקטר"],
     ("משקאות", "משקאות קלים", "נקטרים ומיצים", "בקבוק נקטר")),
    (["שייק", "משקה קל"],
     ("משקאות", "משקאות קלים", "משקאות קלים", "בקבוקים אישיים")),

    # ══ LAUNDRY / CLEANING ══════════════════════════════════════════════════
    (["תרסיס מסיר כתמים", "מסיר כתמים"],
     ("ניקיון", "מוצרי כביסה", "מוצרי כביסה נלווים",
      "תרסיס מסיר כתמים")),
    (["אבקת מסיר כתמים"],
     ("ניקיון", "מוצרי כביסה", "מוצרי כביסה נלווים",
      "אבקת מסיר כתמים")),
    (["מבשם כביסה"],
     ("ניקיון", "מוצרי כביסה", "מוצרי כביסה נלווים", "מבשם כביסה")),
    # Order matters: specific first
    (["גל כביסה לכביסה לבנה", "ג'ל כביסה לבנה", "כביסה לבנה"],
     ("ניקיון", "מוצרי כביסה", "ניקוי כביסה", "ג'ל כביסה לבנה")),
    (["גל כביסה לכביסה צבעונית", "גל כביסה צבעונית",
      "ג'ל כביסה צבעונית", "כביסה צבעונית"],
     ("ניקיון", "מוצרי כביסה", "ניקוי כביסה", "ג'ל כביסה צבעונית")),
    (["גל כביסה", "ג'ל כביסה"],
     ("ניקיון", "מוצרי כביסה", "ניקוי כביסה", "ג'ל כביסה לבנה")),
    (["מרכך כביסה"],
     ("ניקיון", "מוצרי כביסה", "מרכך כביסה", "מרכך כביסה רגיל")),

    # ══ SWEETS / SNACKS ═════════════════════════════════════════════════════
    (["לוקיטוס", "שטיחים חמוצים"],
     ("מזון יבש", "מתוקים ומלוחים", "סוכריות",
      "סוכריות גומי / ג'לי")),
    (["סוכריות גומי", "סוכריות ג'לי"],
     ("מזון יבש", "מתוקים ומלוחים", "סוכריות",
      "סוכריות גומי / ג'לי")),
    (["שוקולד"],
     ("מזון יבש", "מתוקים ומלוחים", "שוקולד", "טבלאות שוקולד")),
    (["מארזי פורים"],
     ("מזון יבש", "מתוקים ומלוחים", "מוצרי חגים", "מארזי פורים")),
    (["חטיף פופקורן"],
     ("מזון יבש", "מתוקים ומלוחים", "חטיפים מלוחים",
      "חטיף פופקורן")),
    (["חטיף במבה", "בומבה"],
     ("מזון יבש", "מתוקים ומלוחים", "חטיפים מלוחים",
      "חטיף במבה")),
    (["ביסלי"],
     ("מזון יבש", "מתוקים ומלוחים", "חטיפים מלוחים",
      "חטיף ביסלי")),

    # ══ NF — TEXTILES ═══════════════════════════════════════════════════════
    (["ג'רסי", "סט קיץ יחיד"],
     ("NF", "טקסטיל", "ביגוד", "ביגוד שונה")),
    (["מצעים", "סדין", "ציפית"],
     ("NF", "טקסטיל", "כלי מיטה", "מצעים")),
    (["שמיכה"],
     ("NF", "טקסטיל", "כלי מיטה", "שמיכות קיץ")),
    (["כרית"],
     ("NF", "טקסטיל", "כלי מיטה", "כריות")),
    (["מגבת"],
     ("NF", "טקסטיל", "מגבות", "מגבות גוף")),
    (["שטיח"],
     ("NF", "טקסטיל", "טקסטיל לבית", "שטיחים")),
    (["מפה", "מפות שולחן"],
     ("NF", "טקסטיל", "טקסטיל לבית", "מפות")),
    (["גרב", "גרביים"],
     ("NF", "טקסטיל", "ביגוד", "גרבי גברים")),
    (["צעיף"],
     ("NF", "טקסטיל", "אביזרי חורף", "צעיפים")),
    (["כפפות"],
     ("NF", "טקסטיל", "אביזרי חורף", "כפפות")),
    (["מטריה"],
     ("NF", "טקסטיל", "אביזרי חורף", "מטריות")),

    # ══ NF — HOUSEHOLD / KITCHEN ════════════════════════════════════════════
    # Naaman brand & general kitchen tools
    (["שקית זילוף", "מגרדת", "כד מידה", "patisserie", "נעמן"],
     ("NF", "כלי בית", "כלי מטבח", "אביזרי מטבח")),
    (["שיפודים", "בקבוק זילוף"],
     ("NF", "כלי בית", "כלי מטבח", "אביזרי מטבח")),
    (["קולפן", "פותחן"],
     ("NF", "כלי בית", "כלי מטבח", "קולפנים ופותחנים")),
    (["מסננת"],
     ("NF", "כלי בית", "כלי מטבח", "מסננות")),
    (["מחבת"],
     ("NF", "כלי בית", "כלי מטבח", "מחבתות")),
    (["סיר"],
     ("NF", "כלי בית", "כלי מטבח", "סירים")),
    (["סכין", "סכינים"],
     ("NF", "כלי בית", "כלי מטבח", "סכינים")),
    (["קערה", "קערות"],
     ("NF", "כלי בית", "כלי מטבח", "קערות")),
    # Table & serving
    (["מרקיה", "קערה אובלית", "שיפודים קצרים"],
     ("NF", "כלי בית", "כלי שולחן", "מגשים וכלי הגשה")),
    (["כוס", "כוסות"],
     ("NF", "כלי בית", "כלי שולחן", "כוסות")),
    (["צלחות"],
     ("NF", "כלי בית", "כלי שולחן", "צלחות")),
    (["מגש נירוסטה", "מגש לדג"],
     ("NF", "כלי בית", "כלי שולחן", "מגשים וכלי הגשה")),
    # Storage
    (["צנצנת", "קופסאות אחסון"],
     ("NF", "כלי בית", "כלי אחסון", "מוצרי אחסון פלסטיק")),
    (["קערה גמישה"],
     ("NF", "כלי בית", "כלי אחסון", "מוצרי אחסון פלסטיק")),
    # Household
    (["פח"],
     ("NF", "כלי בית", "מוצרים לבית", "פחים")),
    (["מעצור דלת"],
     ("NF", "כלי בית", "מוצרים לבית", "מוצרים לבית")),
    (["לוח מחיק"],
     ("NF", "כלי בית", "מוצרים לבית", "מוצרים לבית")),
    (["סלסלה", "סל"],
     ("NF", "כלי בית", "מוצרים לבית", "סלסלאות אחסון")),
    (["קרש גיהוץ", "מתלה כביסה"],
     ("NF", "כלי בית", "מוצרים לבית", "קרש גיהוץ ומתלה כביסה")),
    # Bathroom
    (["פרלטור", "ברז", "חסכמן"],
     ("NF", "כלי בית", "מוצרים לאמבטיה", "ברזים וחסכמים")),
    (["מברשת אסלה"],
     ("NF", "כלי בית", "מוצרים לאמבטיה", "מברשות אסלה")),
    (["דלי", "סל כביסה"],
     ("NF", "כלי בית", "מוצרים לאמבטיה", "דליים וסלי כביסה")),
    (["וילון אמבטיה"],
     ("NF", "כלי בית", "מוצרים לאמבטיה", "וילונות אמבטיה")),
    (["סבוניה", "מתקן לכיור"],
     ("NF", "כלי בית", "מוצרים לאמבטיה", "סבוניות ומתקנים לכיור")),
    # Cleaning tools
    (["מטאטא"],
     ("NF", "כלי בית", "אביזרי ניקיון", "מטאטאים")),
    (["מגב"],
     ("NF", "כלי בית", "אביזרי ניקיון", "מגבים")),
    (["מברשות ניקיון"],
     ("NF", "כלי בית", "אביזרי ניקיון", "מברשות ניקיון")),

    # ══ NF — ELECTRICAL ═════════════════════════════════════════════════════
    (["משקל אדם", "משקל דיגיטלי"],
     ("NF", "מוצרי חשמל", "מכשירי חשמל לבית", "מכשירי מדידה")),
    (["שואב אבק"],
     ("NF", "מוצרי חשמל", "מכשירי חשמל לבית", "שואבי אבק")),
    (["מגהץ"],
     ("NF", "מוצרי חשמל", "מכשירי חשמל לבית", "מגהצים")),
    (["מאוורר"],
     ("NF", "מוצרי חשמל", "מכשירי חשמל לבית", "מאווררים")),
    (["קומקום", "מיחם"],
     ("NF", "מוצרי חשמל", "מכשירי חשמל למטבח", "קומקומים ומיחמים")),
    (["טוסטר", "מצנם"],
     ("NF", "מוצרי חשמל", "מכשירי חשמל למטבח",
      "טוסטרים ומצנמים")),
    (["מיקסר", "מעבד מזון"],
     ("NF", "מוצרי חשמל", "מכשירי חשמל למטבח",
      "מיקסרים ומעבדי מזון")),
    (["מסחטה"],
     ("NF", "מוצרי חשמל", "מכשירי חשמל למטבח",
      "מסחטות ומשקלים")),
    (["נורה", "גוף תאורה", "תאורת חירום", "פנס"],
     ("NF", "מוצרי חשמל", "אביזרי חשמל ותאורה",
      "נורות וגופי תאורה")),
    (["תקע", "שקע", "כבל חשמל"],
     ("NF", "מוצרי חשמל", "אביזרי חשמל ותאורה",
      "תקעים וכבלים")),
    (["סוללה", "סוללות"],
     ("NF", "מוצרי חשמל", "אלקטרוניקה", "סוללות")),
    (["אוזניות"],
     ("NF", "מוצרי חשמל", "אלקטרוניקה", "אוזניות")),
    (["מטען", "כבל טעינה"],
     ("NF", "מוצרי חשמל", "אלקטרוניקה", "מטענים וכבלים")),

    # ══ NF — LEISURE / TOYS / STATIONERY ════════════════════════════════════
    (["4 בשורה", "צוללות", "בול פגיעה",
      "שחמט", "דמקה", "משחק קופסא"],
     ("NF", "פנאי", "צעצועים", "משחקי קופסא")),
    (["פאזל"],
     ("NF", "פנאי", "צעצועים", "משחקי קופסא")),
    (["רכב צעצוע", "מכונית צעצוע"],
     ("NF", "פנאי", "צעצועים", "משחקי רכב")),
    (["בובה"],
     ("NF", "פנאי", "צעצועים", "בובות")),
    (["נעצים", "קליפס", "מגנטים", "גומיות", "אטב עץ",
      "סיכות שדכן", "מחזיקי מפתחות", "סרטי מדידה",
      "נייר גרוס", "אזיקונים"],
     ("NF", "פנאי", "ציוד משרדי", "ציוד משרדי")),
    (["סימניות דגלונים"],
     ("NF", "פנאי", "ציוד משרדי", "ציוד משרדי")),
    (["עט", "עפרון", "כלי כתיבה"],
     ("NF", "פנאי", "ציוד משרדי", "כלי כתיבה")),
    (["מחברת", "בלוק", "מחברות"],
     ("NF", "פנאי", "ציוד משרדי",
      "מחברות בלוקים ומעטפות")),
    (["מדבקות"],
     ("NF", "פנאי", "יצירה", "מדבקות")),
    (["בלון"],
     ("NF", "פנאי", "אביזרי מסיבה", "בלונים")),
    (["קונפטי"],
     ("NF", "פנאי", "אביזרי מסיבה", "מוצרי יום הולדת")),
    (["פחמים"],
     ("NF", "פנאי", "קמפינג", "מנגל")),
    (["מנגל"],
     ("NF", "פנאי", "קמפינג", "מנגל")),

    # ══ PHARMACY — DENTAL ═══════════════════════════════════════════════════
    (["מברשת שיניים", "מברשות שיניים"],
     ("פארם", "הגיינת הפה", "מברשות שיניים",
      "מברשות שיניים מתקדמות")),
    (["חוט דנטלי", "מקלון חוט דנטלי"],
     ("פארם", "הגיינת הפה", "אביזרים לפה", "חוטים דנטליים")),
    (["מגרד לשון"],
     ("פארם", "הגיינת הפה", "אביזרים לפה", "חוטים דנטליים")),
    (["מי פה"],
     ("פארם", "הגיינת הפה", "שטיפה דנטלית", "מי פה")),
    (["משחת שיניים"],
     ("פארם", "הגיינת הפה", "משחות שיניים",
      "משחות שיניים רגילות")),

    # ══ PHARMACY — PERSONAL CARE ════════════════════════════════════════════
    (["אקססוריז רחצה", "ספוג רחצה", "ספוגי רחצה", "ליפה"],
     ("פארם", "טיפוח הגוף", "סבונים", "ספוגי רחצה")),
    (["ג'ל רחצה", "תחליב רחצה"],
     ("פארם", "טיפוח הגוף", "סבונים", "ג'ל רחצה")),
    (["סבון מוצק"],
     ("פארם", "טיפוח הגוף", "סבונים", "סבון מוצק")),
    (["סבון נוזלי", "סבון ידיים"],
     ("פארם", "טיפוח הגוף", "סבונים", "סבון נוזלי לידיים")),
    (["שמפו"],
     ("פארם", "טיפוח הגוף", "שמפו מרכך", "שמפו לשיער")),
    (["מרכך לשיער", "מרכך שיער"],
     ("פארם", "טיפוח הגוף", "שמפו מרכך", "מרכך לשיער")),
    (["דאודורנט"],
     ("פארם", "טיפוח הגוף", "דאודורנטים", "דאודורנט ספריי")),
    (["קרם ידיים"],
     ("פארם", "טיפוח הגוף", "משחות וקרמים", "קרם ידיים")),
    (["קרם גוף"],
     ("פארם", "טיפוח הגוף", "משחות וקרמים", "קרם גוף")),
    (["הגנה משמש", "קרם הגנה"],
     ("פארם", "טיפוח הגוף", "הגנה משמש",
      "תחליב הגנה משמש")),

    # ══ PHARMACY — HYGIENE ══════════════════════════════════════════════════
    (["תחבושות", "תחבושת"],
     ("פארם", "מוצרי הגיינה", "הגיינה נשית", "תחבושות")),
    (["מגן תחתון"],
     ("פארם", "מוצרי הגיינה", "הגיינה נשית", "מגן תחתון")),
    (["טמפון"],
     ("פארם", "מוצרי הגיינה", "הגיינה נשית", "טמפונים")),
    (["צמר גפן"],
     ("פארם", "מוצרי הגיינה", "צמר גפן", "צמר גפן רפואי")),
    (["פלסטר"],
     ("פארם", "מוצרי הגיינה", "צמר גפן", "פלסטרים")),
    (["מסרק כינים"],
     ("פארם", "מוצרי הגיינה", "טיפוח והסרת שיער",
      "מסרק כינים")),
    (["סכין גילוח", "סכיני גילוח"],
     ("פארם", "מוצרי הגיינה", "טיפוח והסרת שיער",
      "סכיני גילוח")),

    # ══ PHARMACY — BABY ═════════════════════════════════════════════════════
    (["רפידות הנקה", "רפידות"],
     ("פארם", "תינוקות", "תינוקות והנקה", "רפידות")),
    (["חיתולים", "חיתול"],
     ("פארם", "תינוקות", "חיתולים", 'חיתולים ח"פ')),
    (["חיתולי גמילה"],
     ("פארם", "תינוקות", "חיתולים", "חיתולי גמילה")),
    (["מגבונים לחים", "מגבונים"],
     ("פארם", "תינוקות", "מגבונים", "מארז מגבונים לחים")),
    (["שמפו לתינוק"],
     ("פארם", "תינוקות", "טיפוח תינוקות", "שמפו לתינוק")),
    (["מוצץ"],
     ("פארם", "תינוקות", "אביזרי תינוקות", "מוצצים")),
    (["בקבוק לתינוק"],
     ("פארם", "תינוקות", "אביזרי תינוקות",
      "בקבוקים לתינוק")),

    # ══ NUTS — additional keywords ═══════════════════════════════════════════
    # Blanched/ground hazelnuts → baking ingredient
    (["אגוז לוז מולבן", "אגוז לוז טחון", "אגוזי לוז טחונים"],
     ("מזון יבש", "מוצרים לבישול ואפיה",
      "מוצרי עזר לאפיה", "פרג שומשום וקוקוס")),
    # Natural hazelnuts → VAT-exempt
    (["אגוז לוז", "אגוזי לוז"],
     ("פירות וירקות", 'פיצוחים ללא מע"מ',
      'פיצוחים ללא מע"מ', 'פיצוחים טבעיים שונים')),
    # Macadamia natural → VAT-exempt
    (["מקדמיה טבעי", "מקדמיה טבעית"],
     ("פירות וירקות", 'פיצוחים ללא מע"מ',
      'פיצוחים ללא מע"מ', 'פיצוחים טבעיים שונים')),
    # Macadamia roasted → VAT
    (["מקדמיה"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "אגוזים קלויים")),
    # Pistachios (shelled/roasted → VAT)
    (["פיסטוק מקולף", "פיסטוק שלם"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "קשיו ופיסטוק קלויים")),
    # Cashews natural → still VAT (always come processed)
    (["קאשיו", "קשיו"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "קשיו ופיסטוק קלויים")),
    # Pecan
    (["פקאן ציפוי", "פקאן מסוכר"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "ממתקי פיצוחים", "ממתקי פיצוחים")),
    (["פקאן"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "אגוזים קלויים")),
    # Natural almonds (Israeli, with skin = VAT-exempt)
    (["שקד ישראל", "שקד עם קליפה"],
     ("פירות וירקות", 'פיצוחים ללא מע"מ',
      'פיצוחים ללא מע"מ', 'שקדים ללא מע"מ')),
    # Walnuts (peeled → VAT)
    (["אגוז מלך", "אגוזי מלך"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "אגוזים קלויים")),
    # Sunflower/pumpkin seeds keyword (no "טבעי")
    (["גרעיני חמניה", "גרעין חמניה"],
     ("פירות וירקות", 'פיצוחים עם מע"מ',
      "פיצוחים קלויים", "גרעינים קלויים")),

    # ══ DELI / COLD CUTS ═════════════════════════════════════════════════════
    (["פסטרמה", "נקניקיות", "נקניק", "סלמי", "שניצל מצונן",
      "כבד עוף", "קבב מצונן"],
     ("מצוננים", "מעדניה", "נקניקיות", "נקניקיות עוף")),

    # ══ WINE / SPIRITS ═══════════════════════════════════════════════════════
    (["יין"],
     ("משקאות", "יינות", "יינות אדומים", "יין אדום")),
    (["וויסקי", "ברנדי", "רום", "וודקה", "ג'ין", "ליקר"],
     ("משקאות", "משקאות חריפים", "משקאות חריפים", "משקאות חריפים")),

    # ══ BOARD GAMES / TOYS ════════════════════════════════════════════════════
    (["בינגו", "רולטה", "עולם האותיות", "מיהו המיליונר",
      "גשרים ונחשים", "שדה קרב", "מפולת כסאות",
      "הפירט השיכור", "רמי מספרים", "רמי מילים",
      "4 במבוך", "מצא את המילה", "זהירות אתה נופל"],
     ("NF", "פנאי", "צעצועים", "משחקי קופסא")),

    # ══ GRAINS / LEGUMES / DRY GOODS ════════════════════════════════════════
    (["גריסים"],
     ("מזון יבש", "קולינרי", "אורז דגנים ופסטה", "גריסים")),
    (["אפונה"],
     ("מזון יבש", "שימורים וממרחים", "קטניות ודגנים שימורים", "אפונה")),
    (["פול מצרי", "פול"],
     ("מזון יבש", "שימורים וממרחים", "קטניות ודגנים שימורים", "פול")),
    (["לבבות דקל"],
     ("מזון יבש", "שימורים וממרחים", "ירקות שימורים", "לבבות דקל")),
    (["מלפפון חמוץ", "מלפפון במלח"],
     ("מזון יבש", "שימורים וממרחים", "ירקות שימורים", "מלפפונים חמוצים")),
    (["אצות נורי", "אצות לסושי"],
     ("מזון יבש", "קולינרי", "מאכלים אסייתים", "אצות")),
    (["טורטיה"],
     ("מזון יבש", "לחם ומאפים", "לחמים מיוחדים", "לחמי שטוחים")),
    (["אטריות", "נודלס"],
     ("מזון יבש", "קולינרי", "אורז דגנים ופסטה", "פסטה יבשה")),
    (["ספגטי", "פסטה"],
     ("מזון יבש", "קולינרי", "אורז דגנים ופסטה", "פסטה יבשה")),
    (["קוסקוס"],
     ("מזון יבש", "קולינרי", "אורז דגנים ופסטה", "קוסקוס")),
    (["עמבה"],
     ("מזון יבש", "שימורים וממרחים", "ממרחים ורטבים", "ממרחים ורטבים")),
    (["רכז רימונים", "מיץ רימונים"],
     ("משקאות", "משקאות קלים", "נקטרים ומיצים", "מיץ טבעי")),
    (["חלב מרוכז"],
     ("מזון יבש", "מוצרים לבישול ואפיה", "מוצרי עזר לאפיה", "שמנת וחלב מרוכז")),
    (["זרעי פשתן", "קצח"],
     ("מזון יבש", "מוצרים לבישול ואפיה",
      "מוצרי עזר לאפיה", "פרג שומשום וקוקוס")),

    # ══ REFRIGERATED / DAIRY ═════════════════════════════════════════════════
    (["יוגורט"],
     ("מצוננים", "חלב ומוצריו", "יוגורט", "יוגורטים")),
    (["ג'חנון"],
     ("קפואים", "מאפים קפואים", "לחם קפוא", "ג'חנון")),

    # ══ FROZEN / ICE CREAM ════════════════════════════════════════════════════
    (["קרטיב", "מצופים שוקו"],
     ("קפואים", "גלידות", "גלידה בודדים", "טילונים בודדים")),
    (["קוקי מיקס", "קלאסיק מיקס"],
     ("קפואים", "גלידות", "מאגדות גלידה", "מאגדת טילונים")),
    (["בלינצ'ס"],
     ("קפואים", "מאפים קפואים", "בורקס ומאפים", "בלינצ'ס")),
    (["ווופל", "וופל"],
     ("קפואים", "מאפים קפואים", "בורקס ומאפים", "בורקס ומאפים")),
    (["בטטה צ'יפס", "בטטה צ'יפס", "טבעות בצל"],
     ("קפואים", "ירקות קפואים", "ירקות קפואים", "ירקות קפואים")),
    (["קריספיות"],
     ("מזון יבש", "דגנים וחטיפי דגנים", "דגני בוקר", "קריספיות")),

    # ══ BABY PRODUCTS (additional) ════════════════════════════════════════════
    (["נשכן", "מוצץ סיליקון"],
     ("פארם", "תינוקות", "אביזרי תינוקות", "מוצצים")),
    (["פטמה", "פטמות"],
     ("פארם", "תינוקות", "אביזרי תינוקות", "בקבוקים לתינוק")),
    (["מספריים לתינוק", "קוצץ ציפורניים לתינוק"],
     ("פארם", "תינוקות", "אביזרי תינוקות", "מוצצים")),
    (["בייבי ביס", "נגיסי אורז"],
     ("פארם", "תינוקות", "מזון תינוקות", "חטיפי תינוקות")),

    # ══ PHARMACY / MEDICAL (additional) ══════════════════════════════════════
    (["מד חום", "מד חום דיגיטלי"],
     ("פארם", "מכשור רפואי", "מכשור ביתי", "מדי חום")),
    (["אלכוהול 70%", "אלכוהול רפואי"],
     ("פארם", "מוצרי הגיינה", "צמר גפן", "אלכוהול")),
    (["קיסמי שיניים", "קיסם שיניים", "קיסמי שיניים דנטליים"],
     ("פארם", "הגיינת הפה", "אביזרים לפה", "קיסמי שיניים")),

    # ══ NF — KITCHEN TOOLS (additional) ═════════════════════════════════════
    (["כותש שום", "מועך שום"],
     ("NF", "כלי בית", "כלי מטבח", "אביזרי מטבח")),
    (["מצית", "מצית גז"],
     ("NF", "כלי בית", "מוצרים לבית", "מוצרים לבית")),
    (["נפה", "מסננת קמח"],
     ("NF", "כלי בית", "כלי מטבח", "מסננות")),
    (["סקוויזר", "בקבוק ספורט"],
     ("NF", "כלי בית", "כלי שולחן", "כוסות")),
    (["רשת לכיור", "פקק לכיור"],
     ("NF", "כלי בית", "מוצרים לאמבטיה", "סבוניות ומתקנים לכיור")),
    (["כפות בישול", "כף בישול"],
     ("NF", "כלי בית", "כלי מטבח", "אביזרי מטבח")),
    (["פינג'ן"],
     ("NF", "כלי בית", "כלי שולחן", "כוסות")),
    (["אינטרדנטלי", "חוט אינטרדנטלי"],
     ("פארם", "הגיינת הפה", "אביזרים לפה", "חוטים דנטליים")),
    (["מגן פמוט"],
     ("ניקיון", "טיפוח הבית", "נרות", "אביזרים לנרות")),
    (["שמן למאור", "שמן זית למאור"],
     ("ניקיון", "טיפוח הבית", "נרות", "שמן למאור")),
    (["צ'ופסטיקס", "מקלות אכילה"],
     ("NF", "כלי בית", "כלי שולחן", "מגשים וכלי הגשה")),
    (["מזוודה", "מזוודות"],
     ("NF", "פנאי", "קמפינג", "אביזרי נסיעה")),
    (["אלבום תמונות", "אלבום הדבקה"],
     ("NF", "פנאי", "ציוד משרדי", "ציוד משרדי")),
    (["ספר לצביעה", "ספר צביעה"],
     ("NF", "פנאי", "יצירה", "צבעים ולורדים")),

    # ══ CEREALS / GRANOLA ════════════════════════════════════════════════════
    (["גרנולה"],
     ("מזון יבש", "דגנים וחטיפי דגנים", "גרנולה ודגנים טבעיים", "גרנולות")),
    (["קוואקר", "שיבולת שועל", "פתיתי שיבולת"],
     ("מזון יבש", "דגנים וחטיפי דגנים", "גרנולה ודגנים טבעיים", "קוואקר")),

    # ══ HALVA & COATED NUT SWEETS ════════════════════════════════════════════
    (["חלבה", "חלווה"],
     ("מזון יבש", "מתוקים ומלוחים", "חטיפים מתוקים", "חלווה")),
    (["מסוכר", "מצופה", "בציפוי שוקולד", "בציפוי דבש",
      "שקד מסוכר", "בוטן מסוכר", "אגוז מסוכר", "אגוזים מסוכרים"],
     ("פירות וירקות", 'פיצוחים עם מע"מ', "ממתקי פיצוחים", "ממתקי פיצוחים")),

    # ══ DRIED FRUITS (additional) ════════════════════════════════════════════
    (["תמר מגהול", "תמרים", "תמר"],
     ("פירות וירקות", 'פיצוחים עם מע"מ', "פירות יבשים", "פירות יבשים")),
    (["בננה ציפס", "צ'יפס בננה", "בננה מיובשת"],
     ("פירות וירקות", 'פיצוחים עם מע"מ', "פירות יבשים", "חטיפי פירות")),
    (["חמוציות", "תאנים מיובש", "תאנה מיובשת", "תאנים יבשות",
      "תפוח עץ יבש", "תפוחי עץ יבשים", "קוקוס לבן", "קוקוס פרוס",
      "אוכמניות מיובשות", "ענבים מיובשים"],
     ("פירות וירקות", 'פיצוחים עם מע"מ', "פירות יבשים", "פירות יבשים")),

    # ══ NATURAL NUTS — additional VAT-exempt ════════════════════════════════
    (["צנובר", "צנוברים"],
     ("פירות וירקות", 'פיצוחים ללא מע"מ',
      'פיצוחים ללא מע"מ', 'פיצוחים טבעיים שונים')),
    (["פקאן טבעי", "פקאן מקולף"],
     ("פירות וירקות", 'פיצוחים ללא מע"מ',
      'פיצוחים ללא מע"מ', 'פיצוחים טבעיים שונים')),

    # ══ SPICES — alternate spelling variant (single י) ═══════════════════════
    (["פטרוזליה יבשה"],
     ("מזון יבש", "מוצרים לבישול ואפיה",
      "תבלינים", "תיבולים ותערובות שונות")),

    # ══ CLEANING — additional ════════════════════════════════════════════════
    (["נוזל לניקוי כלים", "ניקוי כלים", "נוזל כלים", "מרכך לכלים",
      "סבון לכלים"],
     ("ניקיון", "חומרי ניקוי", "ניקוי כלים", "נוזל לניקוי כלים")),
    (["מרסס חלונות", "ניקוי חלונות", "ניקוי זכוכית", "מרחיק לחות"],
     ("ניקיון", "חומרי ניקוי", "ניקוי לבית", "ניקוי לחלונות")),
    (["חומר ניקוי", "ספריי ניקוי", "אקונומיקה"],
     ("ניקיון", "חומרי ניקוי", "ניקוי לבית", "ניקוי לבית")),

    # ══ REFRIGERATED PREPARED FOOD ═══════════════════════════════════════════
    (["פסטה מצוננת", "רביולי", "טורטלוני", "ניוקי"],
     ("מצוננים", "חלב ומוצריו", "מצונן לבישול ואפיה", "פסטה מצוננת")),

    # ══ PHARMACY — additional ════════════════════════════════════════════════
    (["מסיר לק", "אצטון", "אצטון ציפורניים"],
     ("פארם", "ניקוי וטיפוח", "ניקוי וטיפוח", "מסיר לק")),
    (["לוף", "לופה", "ספוג לוף"],
     ("פארם", "טיפוח הגוף", "סבונים", "ספוגי רחצה")),

    # ══ JUDAICA ══════════════════════════════════════════════════════════════
    (["ציצית", "טלית", "גופיית ציצית", "בגד ציצית", "ציצית גברים"],
     ("NF", "יודאיקה", "ציצית וטלית", "ציצית וטלית")),

    # ══ PLANTS / GARDEN ═════════════════════════════════════════════════════
    (["לוונדר", "עציץ", "צמח"],
     ("NF", "פנאי", "יצירה", "צבעים ולורדים")),
]


def match_by_keyword(name: str):
    """Returns (domain, dept, group, subgroup) or None."""
    name_lower = name.lower() if name else ""
    for keywords, category in RULES:
        for kw in keywords:
            if kw.lower() in name_lower:
                return category
    return None


# ---------------------------------------------------------------------------
# 4. Main classification
# ---------------------------------------------------------------------------

def classify_products(taxonomy, products_ws):
    results = []
    stats = {"auto_full": 0, "auto_subgroup": 0, "new_category": 0,
             "partial_auto": 0, "skipped": 0, "unknown": 0}
    new_categories = set()

    for row in products_ws.iter_rows(min_row=2, values_only=True):
        item_id, item_name, domain, dept, group, subgroup, supplier_id, supplier_name = row

        # Skip placeholder items
        if item_name and "פריט חדש" in str(item_name):
            stats["skipped"] += 1
            results.append({
                "item_id": item_id, "item_name": item_name,
                "domain": domain, "dept": dept, "group": group,
                "subgroup": "פריט לא קיים - לדילוג",
                "sub_id": None,
                "supplier_id": supplier_id, "supplier_name": supplier_name,
                "status": "skipped"
            })
            continue

        # Case 1: Has dept + group → find subgroup from taxonomy
        if dept and group:
            found_sub, found_id = find_subgroup_full(
                dept, group, item_name, taxonomy)
            if found_sub:
                stats["auto_subgroup"] += 1
                results.append({
                    "item_id": item_id, "item_name": item_name,
                    "domain": domain, "dept": dept, "group": group,
                    "subgroup": found_sub, "sub_id": found_id,
                    "supplier_id": supplier_id, "supplier_name": supplier_name,
                    "status": "auto_subgroup"
                })
                continue

        # Case 2/3: Try keyword match
        kw_result = match_by_keyword(item_name)
        if kw_result:
            new_domain, new_dept, new_group, new_sub = kw_result
            sub_id = find_sub_id(
                new_domain, new_dept, new_group, new_sub, taxonomy)

            if sub_id is None:
                # Truly new category — not in taxonomy or NEW_TAXONOMY_ENTRIES
                new_categories.add(
                    (new_domain, new_dept, new_group, new_sub))
                stats["new_category"] += 1
                status = "new_category"
            else:
                # Check if the category is from NEW_TAXONOMY_ENTRIES (proposed new)
                is_new_entry = any(
                    t["sub_id"] == sub_id for t in NEW_TAXONOMY_ENTRIES)
                if is_new_entry:
                    stats["new_category"] += 1
                    status = "new_category"
                else:
                    stats["auto_full"] += 1
                    status = "auto_full"

            results.append({
                "item_id": item_id, "item_name": item_name,
                "domain": new_domain, "dept": new_dept,
                "group": new_group, "subgroup": new_sub,
                "sub_id": sub_id,
                "supplier_id": supplier_id, "supplier_name": supplier_name,
                "status": status
            })
            continue

        # Case 4: Has dept but no group → take first taxonomy match
        if dept and not group:
            dept_matches = [t for t in taxonomy
                            if (t["dept_name"] or "").strip() == dept
                            and t["sub_name"]]
            if dept_matches:
                t = dept_matches[0]
                stats["partial_auto"] += 1
                results.append({
                    "item_id": item_id, "item_name": item_name,
                    "domain": domain or t["domain_name"],
                    "dept": dept,
                    "group": t["grp_name"],
                    "subgroup": t["sub_name"] + " *לבדיקה*",
                    "sub_id": None,
                    "supplier_id": supplier_id, "supplier_name": supplier_name,
                    "status": "partial_auto"
                })
                continue

        # Unknown — needs manual review
        stats["unknown"] += 1
        results.append({
            "item_id": item_id, "item_name": item_name,
            "domain": domain or "לא ידוע",
            "dept": dept or "לבדיקה",
            "group": group or "לבדיקה",
            "subgroup": "לבדיקה ידנית",
            "sub_id": None,
            "supplier_id": supplier_id, "supplier_name": supplier_name,
            "status": "unknown"
        })

    return results, stats, new_categories


# ---------------------------------------------------------------------------
# 5. Write output Excel
# ---------------------------------------------------------------------------

STATUS_COLORS = {
    "auto_full":     "C6EFCE",   # green
    "auto_subgroup": "DDEBF7",   # light blue
    "new_category":  "FFEB9C",   # yellow — new category needed
    "partial_auto":  "FCE4D6",   # orange — review recommended
    "unknown":       "FFCCCC",   # red — manual review required
    "skipped":       "D9D9D9",   # grey
}

STATUS_LABELS = {
    "auto_full":     "סווג אוטומטי",
    "auto_subgroup": "קבוצת משנה אוטומטית",
    "new_category":  "קטגוריה חדשה",
    "partial_auto":  "לבדיקה - חלקי",
    "unknown":       "לבדיקה ידנית",
    "skipped":       "פריט לא קיים",
}


def write_output(results, output_path):
    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = "פריטים מעודכנים"

    headers = [
        "פריט", "שם פריט", "תאור מחלקת על", "שם מחלקה",
        "שם קבוצה", "שם קבוצת משנה", "מספר ק.משנה",
        "ספק", "שם ספק", "סטטוס"
    ]
    ws.append(headers)

    # Header styling
    header_fill = PatternFill("solid", fgColor="4472C4")
    header_font = Font(bold=True, color="FFFFFF")
    for cell in ws[1]:
        cell.fill = header_fill
        cell.font = header_font

    # Bold font for sub_id column
    bold_font = Font(bold=True)

    for r in results:
        sub_id_val = r.get("sub_id")
        row_data = [
            r["item_id"], r["item_name"],
            r["domain"], r["dept"], r["group"], r["subgroup"],
            sub_id_val,
            r["supplier_id"], r["supplier_name"],
            STATUS_LABELS.get(r["status"], r["status"])
        ]
        ws.append(row_data)

        row_idx = ws.max_row
        color = STATUS_COLORS.get(r["status"], "FFFFFF")
        fill  = PatternFill("solid", fgColor=color)
        for col in range(1, 11):
            ws.cell(row=row_idx, column=col).fill = fill

        # Make sub_id cell bold and highlighted
        sub_id_cell = ws.cell(row=row_idx, column=7)
        if sub_id_val is not None:
            sub_id_cell.font = bold_font
            # Darker highlight for the ID column
            id_color = "92D050" if r["status"] in (
                "auto_full", "auto_subgroup") else "FFD966"
            sub_id_cell.fill = PatternFill("solid", fgColor=id_color)

    # Auto-width
    for col in ws.columns:
        max_len = max((len(str(c.value or "")) for c in col), default=0)
        ws.column_dimensions[col[0].column_letter].width = min(
            max_len + 4, 55)

    wb.save(output_path)
    print(f"\nOutput saved: {output_path}")


# ---------------------------------------------------------------------------
# 6. Main
# ---------------------------------------------------------------------------

def main():
    print("Loading taxonomy...")
    taxonomy = load_taxonomy(TAXONOMY_FILE)
    print(f"  Loaded {len(taxonomy)} taxonomy entries "
          f"(including {len(NEW_TAXONOMY_ENTRIES)} new).")

    print("Loading products...")
    wb2 = openpyxl.load_workbook(PRODUCTS_FILE)
    ws2 = wb2.active
    print(f"  Loaded {ws2.max_row - 1} products.")

    print("Classifying products...")
    results, stats, new_categories = classify_products(taxonomy, ws2)

    print("\n── Classification Summary ──────────────────────────────────")
    total = sum(stats.values())
    for k, v in stats.items():
        pct = v / total * 100 if total else 0
        print(f"  {STATUS_LABELS.get(k, k):<30} {v:>5}  ({pct:.1f}%)")
    total_label = 'סה"כ'
    print(f'  {total_label:<30} {total:>5}')

    if new_categories:
        print("\n── NEW Categories (not in taxonomy, not in NEW_TAXONOMY_ENTRIES) ──")
        for nc in sorted(new_categories):
            domain, dept, group, sub = nc
            print(f"  {domain} | {dept} | {group} | {sub}")

    print("\n── New taxonomy entries to CREATE in system ────────────────")
    print("  (marked yellow in output — already assigned proposed IDs)")
    for t in NEW_TAXONOMY_ENTRIES:
        print(f"  [{t['sub_id']}] {t['domain_name']} > "
              f"{t['dept_name']} > {t['grp_name']} > {t['sub_name']}")

    write_output(results, OUTPUT_FILE)

    print("\n── Color Legend ────────────────────────────────────────────")
    print("  🟢 ירוק (כהה בעמודה G) — סווג אוטומטי + מספר ק.משנה קיים")
    print("  🔵 כחול (כהה בעמודה G) — קבוצת משנה הוספה + מספר קיים")
    print("  🟡 צהוב                 — קטגוריה חדשה (מספר מוצע בעמודה G)")
    print("  🟠 כתום                 — סווג חלקי — לבדיקה")
    print("  🔴 אדום                 — לבדיקה ידנית")
    print("  ⬜ אפור                 — פריט לא קיים / לדילוג")


if __name__ == "__main__":
    main()
